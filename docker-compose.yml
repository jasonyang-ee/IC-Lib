version: '3.8'

services:
  # Unified Web Application (Frontend + Backend)
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: allegro-web
    environment:
      # Node Environment
      - NODE_ENV=production
      - PORT=3500
      
      # Database Connection (External PostgreSQL)
      # Update these to match your PostgreSQL server
      - DB_HOST=infra.main.local
      - DB_PORT=5435
      - DB_USER=sami
      - DB_PASSWORD=123456
      - DB_NAME=cip
      
      # CORS Configuration
      - CORS_ORIGIN=*
      
      # Optional: API Keys for vendor integrations
      # - DIGIKEY_CLIENT_ID=your_client_id
      # - DIGIKEY_CLIENT_SECRET=your_client_secret
      # - MOUSER_API_KEY=your_api_key
      # - ULTRA_LIBRARIAN_TOKEN=your_token
      # - SNAPEDA_API_KEY=your_api_key
    ports:
      - "80:80"          # All traffic (frontend + API via nginx proxy)
    volumes:
      - ./download/footprint:/app/download/footprint
      - ./download/symbol:/app/download/symbol
      - ./download/pad:/app/download/pad
      - ./config:/app/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
